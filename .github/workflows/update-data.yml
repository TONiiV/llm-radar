name: Daily Data Update
on:
  schedule:
    - cron: '0 0 * * *'  # Every day at UTC 00:00
  workflow_dispatch: {}    # Manual trigger support

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci

      # Step 0: Discover new models from data sources
      - name: Discover New Models
        continue-on-error: true
        run: npx tsx scripts/cron/discover-models.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 1: Fetch price data → staging
      - name: Fetch OpenRouter
        run: npx tsx scripts/cron/fetch-openrouter.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Fetch LiteLLM
        run: npx tsx scripts/cron/fetch-litellm.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 1b: Fetch benchmark data → staging
      - name: Fetch LMArena Benchmarks
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-benchmarks.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Fetch Epoch AI Benchmarks
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-epoch.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Fetch Artificial Analysis (API)
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-aa-api.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          AA_API_KEY: ${{ secrets.AA_API_KEY }}

      - name: Fetch Artificial Analysis (RSC Fallback)
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-artificial-analysis.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 2: Cross-validate and merge
      - name: Validate and Merge Prices
        run: npx tsx scripts/cron/validate-and-merge.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Validate and Merge Benchmarks
        run: npx tsx scripts/cron/validate-and-merge-benchmarks.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 3: Recalculate normalized scores
      - name: Recalculate Scores
        run: npx tsx scripts/cron/recalculate-scores.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 4: Trigger Vercel page revalidation
      - name: Revalidate Vercel Pages
        continue-on-error: true
        run: |
          CLEAN_URL=$(echo "$VERCEL_URL" | xargs)
          echo "Revalidating: ${CLEAN_URL}/api/revalidate"
          curl -sf -X POST "${CLEAN_URL}/api/revalidate" \
            -H "Content-Type: application/json" \
            -d "{\"secret\": \"$REVALIDATION_SECRET\"}" \
            --max-time 10
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          REVALIDATION_SECRET: ${{ secrets.REVALIDATION_SECRET }}

      # Step 5: Regenerate seed.json from DB
      - name: Regenerate seed.json
        continue-on-error: true
        run: npx tsx scripts/cron/regenerate-seed.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Commit seed.json if changed
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet data/seed.json || (git add data/seed.json && git commit -m "chore: auto-update seed.json" && git push)

      # Step 7: Weekly cleanup (Sundays only)
      - name: Cleanup Old Staging Data
        if: github.event.schedule == '0 0 * * 0' || github.event_name == 'workflow_dispatch'
        run: npx tsx scripts/cron/cleanup-staging.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
