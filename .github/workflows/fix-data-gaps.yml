name: Fix Data Gaps (One-time)
on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  fix:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci

      # Step 1: Fix missing prices (manual + OpenRouter)
      - name: Fix Missing Prices
        run: npx tsx scripts/migrate/fix-data-gaps.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 2: Re-fetch all benchmark data to fill gaps
      - name: Fetch LMArena Benchmarks
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-benchmarks.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Fetch Epoch AI Benchmarks
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-epoch.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Fetch Artificial Analysis (API)
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-aa-api.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          AA_API_KEY: ${{ secrets.AA_API_KEY }}

      - name: Fetch Artificial Analysis (RSC Fallback)
        continue-on-error: true
        run: npx tsx scripts/cron/fetch-artificial-analysis.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 3: Validate and merge all staging data
      - name: Validate and Merge Prices
        run: npx tsx scripts/cron/validate-and-merge.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Validate and Merge Benchmarks
        run: npx tsx scripts/cron/validate-and-merge-benchmarks.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 4: Recalculate scores
      - name: Recalculate Scores
        run: npx tsx scripts/cron/recalculate-scores.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      # Step 5: Regenerate seed.json with updated data
      - name: Regenerate seed.json
        continue-on-error: true
        run: npx tsx scripts/cron/regenerate-seed.ts
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

      - name: Commit seed.json if changed
        continue-on-error: true
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet data/seed.json || (git add data/seed.json && git commit -m "fix: update seed.json with fixed prices and scores" && git push)

      # Step 6: Trigger Vercel revalidation
      - name: Revalidate Vercel Pages
        continue-on-error: true
        run: |
          CLEAN_URL=$(echo "$VERCEL_URL" | xargs)
          curl -sf -X POST "${CLEAN_URL}/api/revalidate" \
            -H "Content-Type: application/json" \
            -d "{\"secret\": \"$REVALIDATION_SECRET\"}" \
            --max-time 10
        env:
          VERCEL_URL: ${{ secrets.VERCEL_URL }}
          REVALIDATION_SECRET: ${{ secrets.REVALIDATION_SECRET }}
